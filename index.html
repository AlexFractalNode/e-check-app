
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>E-Check</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/192/organic-food.png">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root { 
            --bg: #0f172a; 
            --card-bg: #1e293b; 
            --text-main: #f1f5f9; 
            --text-muted: #94a3b8;
            --primary: #10b981; 
            --warning: #f59e0b; 
            --danger: #ef4444; 
            --safe: #22c55e;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            margin: 0; padding: 0; 
            height: 100vh; 
            display: flex; flex-direction: column; 
            overflow: hidden; 
        }
        
        /* Glass Header */
        header { 
            position: absolute; top: 0; left: 0; right: 0;
            padding: 1rem; padding-top: max(1rem, env(safe-area-inset-top));
            text-align: center; 
            background: linear-gradient(180deg, rgba(15,23,42,0.8) 0%, rgba(15,23,42,0) 100%);
            z-index: 20; pointer-events: none;
        }
        header h1 { margin: 0; font-size: 1.1rem; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.5); opacity: 0.9; }
        
        /* Scanner */
        #scanner-wrapper { flex: 1; position: relative; background: #000; }
        #reader { width: 100%; height: 100%; object-fit: cover; }
        
        .scan-overlay { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            display: flex; align-items: center; justify-content: center; 
            pointer-events: none;
        }
        .scan-frame { 
            width: 70%; aspect-ratio: 1; 
            border-radius: 24px; 
            position: relative; 
            box-shadow: 0 0 0 4000px rgba(0,0,0,0.6); 
        }
        .scan-frame::after {
            content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
            border: 2px solid var(--primary); border-radius: 24px;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
        }

        /* Loading */
        .loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.2);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite; display: none; z-index: 30;
        }
        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

        /* Result Sheet */
        #result-sheet { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: var(--card-bg); 
            border-radius: 24px 24px 0 0; 
            padding: 1.5rem; padding-bottom: max(2rem, env(safe-area-inset-bottom));
            transform: translateY(110%); 
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1); 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5); 
            z-index: 40; 
            max-height: 85vh; 
            overflow-y: auto; 
        }
        #result-sheet.open { transform: translateY(0); }
        
        .drag-handle { width: 40px; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; margin: 0 auto 1.5rem auto; }

        /* Product Header */
        .product-header { display: flex; gap: 16px; align-items: center; margin-bottom: 1.5rem; }
        .product-img { 
            width: 70px; height: 70px; border-radius: 14px; 
            background: #334155; object-fit: cover; 
        }
        .product-info { flex: 1; }
        .product-brand { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px; }
        .product-title { margin: 0; font-size: 1.2rem; line-height: 1.2; font-weight: 700; }

        /* Badges Grid */
        .badge-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 1.5rem; }
        .info-badge { 
            background: rgba(255,255,255,0.05); border-radius: 10px; padding: 10px; 
            display: flex; align-items: center; gap: 8px; font-size: 0.85rem; font-weight: 600;
        }
        .icon { font-size: 1.2rem; }
        
        .t-green { color: var(--safe); }
        .t-red { color: var(--danger); }
        .t-grey { color: var(--text-muted); }

        /* List */
        .section-title { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); margin: 0 0 10px 0; text-transform: uppercase; }
        .item-list { display: flex; flex-direction: column; gap: 8px; }
        
        .list-item { 
            background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; transition: background 0.2s;
        }
        .list-item:active { background: rgba(255,255,255,0.1); }
        
        .code-pill { font-family: monospace; font-weight: bold; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; margin-right: 6px; font-size: 0.9rem; }

        .risk-blob { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .bg-green { background: var(--safe); box-shadow: 0 0 6px var(--safe); }
        .bg-orange { background: var(--warning); box-shadow: 0 0 6px var(--warning); }
        .bg-red { background: var(--danger); box-shadow: 0 0 6px var(--danger); }

        /* Button */
        .btn { 
            width: 100%; padding: 16px; border: none; border-radius: 16px; 
            font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 2rem; 
        }
        .btn-close { background: rgba(255,255,255,0.1); color: white; }
        
    </style>
</head>
<body>

<header><h1>E-Check</h1></header>

<div id="scanner-wrapper">
    <div id="reader"></div>
    <div class="scan-overlay"><div class="scan-frame"></div></div>
    <div id="loading" class="loader"></div>
</div>

<div id="result-sheet">
    <div class="drag-handle"></div>
    <div id="result-content"></div>
    <button class="btn btn-close" onclick="startScanner()">Weiter scannen</button>
</div>

<script>
    const LEXIKON_URL = "https://alexfractalnode.github.io/E-Nummern-Lexikon";
    let db = {};
    let html5QrcodeScanner = null;
    let isScanning = true;

    // Lade Datenbank
    fetch('app_database.json').then(r => r.json()).then(data => { db = data; });

    // Hilfsfunktion f√ºr URLs (Slug)
    function createSlug(code, name) {
        return (code + "-" + name).toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
    }

    // Scanner starten
    function startScanner() {
        document.getElementById('result-sheet').classList.remove('open');
        document.getElementById('loading').style.display = 'none';
        
        if(html5QrcodeScanner) return;
        
        // Zwingt R√ºckkamera (environment)
        html5QrcodeScanner = new Html5QrcodeScanner("reader", { 
            fps: 10, 
            qrbox: 250, 
            facingMode: { exact: "environment" } 
        });
        
        html5QrcodeScanner.render(onScanSuccess, (err) => {});
        isScanning = true;
    }

    function onScanSuccess(barcode) {
        if(!isScanning) return;
        isScanning = false;
        try { html5QrcodeScanner.clear(); html5QrcodeScanner = null; } catch(e){}
        analyzeProduct(barcode);
    }

    // Analyse
    async function analyzeProduct(barcode) {
        const sheet = document.getElementById('result-sheet');
        const content = document.getElementById('result-content');
        const loader = document.getElementById('loading');
        
        loader.style.display = 'block';
        content.innerHTML = "";

        try {
            // API Call
            const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
            const data = await response.json();
            loader.style.display = 'none';
            sheet.classList.add('open');

            if (data.status === 0) {
                content.innerHTML = `<h2>ü§∑‚Äç‚ôÇÔ∏è Unbekannt</h2><p>Barcode ${barcode} nicht gefunden.</p>`;
                return;
            }

            const p = data.product;
            
            // --- DATA ANALYSIS ---
            const tags = p.ingredients_analysis_tags || [];
            const allergens = p.allergens_tags || []; 
            
            // Vegan/Veggie
            const isVegan = tags.includes('en:vegan');
            const isNonVegan = tags.includes('en:non-vegan');
            const isVegetarian = tags.includes('en:vegetarian');
            
            // Gluten / Laktose (Naive Suche)
            const hasGluten = allergens.some(a => a.includes('gluten') || a.includes('wheat') || a.includes('rye'));
            const hasMilk = allergens.some(a => a.includes('milk') || a.includes('lactose'));
            
            // Zusatzstoffe
            const additives = p.additives_tags || [];

            // --- HTML BAUEN ---
            
            // Header
            let html = `
                <div class="product-header">
                    <img src="${p.image_front_small_url || 'https://via.placeholder.com/80'}" class="product-img">
                    <div class="product-info">
                        <div class="product-brand">${p.brands || ''}</div>
                        <h2 class="product-title">${p.product_name || 'Produkt'}</h2>
                    </div>
                </div>
                
                <div class="badge-grid">
            `;

            // Badge: Vegan Status
            if(isVegan) html += `<div class="info-badge"><span class="icon">üå±</span><span class="t-green">Vegan</span></div>`;
            else if(isNonVegan) html += `<div class="info-badge"><span class="icon">ü•©</span><span class="t-red">Nicht Vegan</span></div>`;
            else if(isVegetarian) html += `<div class="info-badge"><span class="icon">üßÄ</span><span class="t-green">Vegetarisch</span></div>`;
            else html += `<div class="info-badge"><span class="icon">‚ùì</span><span class="t-grey">Veg-Status?</span></div>`;

            // Badge: Gluten
            if(hasGluten) html += `<div class="info-badge"><span class="icon">üåæ</span><span class="t-red">Gluten</span></div>`;
            else html += `<div class="info-badge"><span class="icon">üçû</span><span class="t-green">Glutenfrei*</span></div>`;

            // Badge: Laktose
            if(hasMilk) html += `<div class="info-badge"><span class="icon">ü•õ</span><span class="t-red">Laktose</span></div>`;
            else html += `<div class="info-badge"><span class="icon">üíß</span><span class="t-green">Laktosefrei*</span></div>`;

            html += `</div>`; 
            html += `<p style="font-size:0.7rem; color:#64748b; margin-top:-10px;">*Basierend auf Allergen-Tags</p>`;

            // Liste der E-Nummern
            if(additives.length > 0) {
                html += `<div class="section-title">Zusatzstoffe</div><div class="item-list">`;
                additives.forEach(tag => {
                    let code = tag.split(':')[1].toUpperCase();
                    let info = db[code];
                    let color = "bg-orange";
                    let name = "Lade...";
                    let link = "#";

                    if(info) {
                        name = info.n;
                        if(info.r.includes("Unbedenklich")) color = "bg-green";
                        if(info.r.includes("Bedenklich") || info.r.includes("Hoch")) color = "bg-red";
                        link = `${LEXIKON_URL}/${createSlug(code, name)}.html`;
                    } else {
                        name = "Nicht in DB";
                    }

                    html += `
                    <div class="list-item" onclick="window.open('${link}', '_blank')">
                        <div style="display:flex; align-items:center;">
                            <span class="risk-blob ${color}"></span>
                            <div><span class="code-pill">${code}</span> <span style="font-weight:600; font-size:0.9rem;">${name}</span></div>
                        </div>
                        <span style="opacity:0.3">‚Ä∫</span>
                    </div>`;
                });
                html += `</div>`;
            } else {
                html += `<div style="text-align:center; padding:20px; color:#94a3b8; background:rgba(255,255,255,0.05); border-radius:12px;">‚úÖ Keine E-Nummern gefunden</div>`;
            }

            content.innerHTML = html;

        } catch (e) {
            loader.style.display = 'none';
            content.innerHTML = "Fehler beim Laden (Internet?).";
            sheet.classList.add('open');
        }
    }

    startScanner();
</script>
</body>
</html>
